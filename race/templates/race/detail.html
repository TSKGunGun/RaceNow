{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block title %}{{ object.name }}詳細情報{% endblock %}

{% block contents %}

<div class="container py-2">
    <div class="row mb-5">
        <div class="col">
            <div class="d-flex justify-content-between">
                <div class="display-5">
                    {{ object.name }}
                    {% if object.status.id == 1 %}
                        <span class="badge bg-info p-2 rounded">{{ object.status.name }}</span>
                    {% elif object.status.id == 2 %}
                        <span class="badge bg-warning p-2 rounded">{{ object.status.name }}</span>
                    {% elif object.status.id == 3 %}
                        <span class="badge bg-success p-2 rounded">{{ object.status.name }}</span>
                    {% elif object.status.id == 4 %}
                        <span class="badge bg-secondary p-2 rounded">{{ object.status.name }}</span>
                    {% endif %}
                </div>
                {% if IsMember %}
                <div class="border border-secondary border-3 rounded bg-dark p-3 d-flex h-stack">
                    
                    <p class="text-light me-3">レースステータス変更</p>
                    {% if Is_canstart %}
                        <form action="{% url 'race_start' object.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning">レース開始</button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
</form>    

    </div>
    <div class="row my-1 bg-light">
        <div class="col">
            <div class="d-flex justify-content-between p-2">
                <div>
                    <span class="h3">基本情報</span>
                </div>
                <div>
                    {% if IsMember == True %}
                    <a role="button" class="btn btn-primary" href="#">基本情報更新</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <table class="table">
                <tr>
                    <th>開催場所</th>
                    <td>{{ object.place.name }}</td>
                </tr>
                <tr>
                    <th>開催日</th>
                    <td>{{ object.event_date }}</td>
                </tr>
                <tr>
                    <th>主催団体</th>
                    <td><a href="{% url 'organizer_detail' pk=object.organizer.id %}">{{ object.organizer.name }}</a></td>
                </tr>
                <tr>
                    <th>レースカテゴリ</th>
                    <td>{{ object.racetype.category.name }}</td>
                </tr>
                <tr>
                    <th>レース形式</th>
                    <td>{{ object.racetype.name }}</td>
                </tr>
                <tr>
                    <th>ホームページURL</th>
                    <td>{{ object.url }}</td>
                </tr>
            </table>   
        </div>
    </div>
    <hr>
    <section id="race_regulation">
        <div class="row my-3 bg-light">
            <div class="col">
                <div class="d-flex justify-content-between p-2">
                    <div>
                        <span class="h3">レースレギュレーション</span>
                        {% if Is_CanChangeRegulation %}
                        <span class="badge bg-warning">レギュレーション未確定</span>
                        {% else %}
                        <span class="badge bg-primary">レギュレーション確定</span>
                        {% endif %}
                    </div>
                    <div>
                        {% if IsMember and Is_CanChangeRegulation %}
                            <a role="button" class="btn btn-primary"  href="">レギュレーション更新</a>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#RegulationFixModal">
                                レギュレーション確定
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class=" row my-1">
            <div class="col">    
                {% if race.is_regulationsetuped %}
                <table class="table">
                    <tr>
                        <th>項目名</th>
                        <th>レギュレーション内容</th>
                    </tr>
                    {% if race.is_teamrace %}
                    <tr>
                        <td>レース形式</td>
                        <td>チームレース</td>
                    </tr>
                    <tr>
                        <td>チーム最小人数</td>
                        <td>{{ race.team_member_count_min }}</td>
                    </tr>
                    <tr>
                        <td>チーム最大人数</td>
                        <td>{{ race.team_member_count_max }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td>レース形式</td>
                        <td>個人レース</td>
                    </tr>
                    {% endif %}
                    {% if race.is_heat %}
                    <tr>
                        <td>ヒート制</td>
                    <td>あり {{ race.heat_count }}ヒート</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td>ヒート制</td>
                        <td>なし(1ヒート)</td>
                    </tr>
                    {% endif %}
                </table>
                {% else %}
                <div class="p-3 border  border-4 rounded text-center bg-noneinfo" >
                    <p class="h5">未設定</p>
                    <a role="button" class="btn btn-primary" href="{% url 'regulations_setup' pk=race.id %}">レギュレーションの設定</a>
                </div>
                {% endif %}
            </div>
        </div>
    </section>
    <div class="row">
        <div class="col">
            <p class="h5">その他掲載情報</p>
            {% if object.note %}
            {{ object.note }}
            {% else %}
            <div class="p-3 border  border-4 rounded h5 text-center bg-noneinfo" >
                記載なし
                </div>
            {% endif %}
        </div>
    </div>
    <section id="race_entrant">
        <div class="row my-3 bg-light">
            <div class="col">
                <div class="d-flex justify-content-between p-2">
                    <div>
                        <span class="h3">エントラント</span>
                    </div>
                    <div>
                        {% if IsMember == True %}
                            {% if Is_Entry %}
                                <a role="button" class="btn btn-primary" href="{% url 'add_entrant' object.id %}">エントラント追加</a>
                                <a role="button" class="btn btn-info" href="">エントラント一覧</a>
                            {% else %}
                            <div class="text-end">
                                <button class="btn btn-primary" href="#" disabled>参加者追加</button>
                                <button class="btn btn-info" href="#" disabled>参加者一覧</button>
                            </div>
                                {% if Is_CanChangeRegulation %}
                                <small class="text-danger">レギュレーションが未確定のため、参加者を追加できません。</small>
                                {% else %}
                                <small class="text-danger">レース開催後は参加者を変更できません。</small>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-1">
            <div class="col">
                {% if object.entrant_set.all %}
                <table class="table">
                    <tr>
                        <th>ゼッケンNo</th>
                        <th>エントラント名</th>
                        <th>メンバー氏名</th>
                    </tr>
                    {% for entrant in object.entrant_set.all %}
                    <tr>
                        <td>{{ entrant.num }}</td>
                        {% if entrant.team_name %}
                            <td>{{ entrant.team_name }}</td>
                        {% else %}
                            <td>
                                <span class="text-muted">チーム名なし</span>
                            </td>
                        {% endif %}
                        <td>
                            {% for member in entrant.entrant_member_set.all %}
                                {{ member.name }} /
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% elif not object.is_regulationsetuped %}
                <div class="p-3 border  border-4 rounded h5 text-center bg-noneinfo" >
                    エントラントの登録にはレギュレーションの設定が必要です。
                </div>
                {% else %}
                <div class="p-3 border  border-4 rounded h5 text-center bg-noneinfo" >
                    エントラント未登録
                </div>
                {% endif %}
            </div>
        </div>
    </section>
    <hr>
    <section id="race_result">    
        <div class="row my-3 bg-light">
            <div class="col">
                <div class="d-flex justify-content-between p-2">
                    <div>
                        <span class="h3">リザルト</span>
                    </div>
                    <div>
                        {% if IsMember == True %}
                            {% if Is_RaceHold %}
                                <a role="button" class="btn btn-primary" href="{% url 'input_result' object.id %}">リザルト入力</a>
                            {% endif %}
                        {% endif %}
                        {% if Is_ShowResult %}
                        <a href="{% url 'show_result' object.id %}" class="btn btn-primary">全リザルト照会</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-1">
            {% if Is_ShowResult %}
            <table class="table table-striped table-hover table-ranking" id="result_data">
                <tr>
                    <th hidden>ID</th>
                    <th class="text-center">順位</th>
                    <th class="text-center">ゼッケンNo</th>
                    <th>チーム名</th>
                    <th>ライダー</th>
                    <th class="text-center">周回数</th>
                </tr>
                {% for item in result %}
                <tr>
                    <td hidden>{{ item.id }}</td>
                    <td class="text-center h4">{{ forloop.counter }}</td>
                    <td class="text-center">{{ item.num }}</td>
                    <td>{{ item.team_name }}</td>
                    <td>{% for member in item.entrant_member_set.all %}{{ member.name }} / {% endfor %}</td>
                    <td class="text-center">{{ item.lapcount }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
                <div class="p-3 border  border-4 rounded h5 text-center bg-noneinfo" >
                    レース開催前のため、リザルトはありません。
                </div>
            {% endif %}
        </div>
    </section>
</div>
<!-- レギュレーション確定モーダル -->
<div class="modal fade" id="RegulationFixModal" tabindex="-1" aria-labelledby="RegulationFixModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="RegulationFixModalLabel">レギュレーション確定確認</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            <p>レースレギュレーションを確定してエントリー開始してももよろしいですか？</p>
            <p class="text-danger">※レギュレーション確定後はレギュレーションを変更できなくなります。</p>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
            <form action="{% url 'race_fixedregulation' object.id %}", method="POST">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">レギュレーション確定</button>
            </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
